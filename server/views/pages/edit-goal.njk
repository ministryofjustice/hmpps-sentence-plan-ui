{% extends "../partials/layout.njk" %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/date-input/macro.njk" import govukDateInput %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/checkboxes/macro.njk" import govukCheckboxes %}
{% from "../components/error-summary/error-summary.njk" import errorSummary %}
{% from "hmpps/components/date-picker/macro.njk" import hmppsDatePicker %}
{% from "moj/components/side-navigation/macro.njk" import mojSideNavigation %}

{% set pageTitle %}
    {% if errors %}
        Error: {{ applicationName }} - Change a goal with {{ data.popData.givenName }}
    {% else %}
       {{ applicationName }} - Change a goal with {{ data.popData.givenName }}
    {% endif %}
{% endset -%}

{% set mainClasses = "app-container govuk-body" %}
{% set locale = interpolate(locale, {
    subject: merge(data.popData, {
        possessiveName: data.popData.givenName | possessive
    }),
    dateOptions: {
        threeMonths: data.dateOptions[0] | formatSimpleDate,
        sixMonths: data.dateOptions[1] | formatSimpleDate,
        twelveMonths: data.dateOptions[2] | formatSimpleDate,
        endOfSentence: data.dateOptions[3] | formatSimpleDate,
        nextMeeting: data.dateOptions[4] | formatSimpleDate
    },
    dateOptionsArray: data.dateOptions
}) %}

{# Setup arrays and custom HTML #}
{% set additionalAreaOfNeedCheckboxes = [] %}
{% for areaOfNeed in data.areasOfNeed %}
    {% if areaOfNeed.name != data.areaOfNeed %}
        {% set isChecked = data.form['other-area-of-need'] and (areaOfNeed.name in data.form['other-area-of-need']) %}
        {% set additionalAreaOfNeedCheckboxes = additionalAreaOfNeedCheckboxes.concat({
            value: areaOfNeed.name,
            text: areaOfNeed.name,
            checked: isChecked
        }) %}
    {% endif %}
{% endfor %}


{% set areasOfNeedHtml %}
    {{ govukCheckboxes({
        name: "other-area-of-need",
        hint: {
          text: "Select all that apply."
        },
        errorMessage: getFormattedError(errors, locale, "other-area-of-need"),
        items: additionalAreaOfNeedCheckboxes
    }) }}
{% endset -%}

{% set customDateHtml %}
    {{ hmppsDatePicker({
        id: "date-selection-custom",
        name: "date-selection-custom",
        errorMessage: getFormattedError(errors, locale, 'date-selection-custom'),
        classes: "govuk-input--width-10",
        hint: {
            text: locale.datePicker.hint
        },
        label: {
            text: locale.datePicker.label,
            classes: "govuk-fieldset__legend--s"
        },
        value: data.form['date-selection-custom'],
        minDate: data.minimumDatePickerDate
    }) }}
{% endset -%}

{% set customDateRadioHtml %}
    {{ govukRadios({
        name: "date-selection-radio",
        fieldset: {
            legend: {
                text: locale.dateSelection.label,
                isPageHeading: false,
                classes: "govuk-fieldset__legend--m"
            }
        },
        hint: {
            text: locale.dateSelection.hint
        },
        errorMessage: getFormattedError(errors, locale, 'date-selection-radio'),
        value: data.form['date-selection-radio'],
        items: [
            {
                value: data.dateOptions[4] | formatISODate,
                text: locale.dateSelection.options.nextMeeting,
                checked: data.form['date-selection-radio'] == data.dateOptions[4] | formatISODate
            },
            {
                value: data.dateOptions[0] | formatISODate,
                text: locale.dateSelection.options.threeMonths
            },
            {
                value: data.dateOptions[1] | formatISODate,
                text: locale.dateSelection.options.sixMonths
            },
            {
                value: data.dateOptions[2] | formatISODate,
                text: locale.dateSelection.options.twelveMonths
            },
            {
                value: data.dateOptions[3] | formatISODate,
                text: locale.dateSelection.options.twentyFourMonths
            },
            {
                divider: "or"
            },
            {
                value: "custom",
                text: locale.dateSelection.customRadioOptionText,
                conditional: {
                    html: customDateHtml
                }
            }
        ]
    }) }}
{% endset -%}

{% block content %}
    <a href="#" class="govuk-back-link">Back</a>
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            {{ errorSummary({
                errors: errors,
                locale: locale
            }) }}
            <span class="govuk-caption-l">{{ data.areaOfNeed }}</span>
            <h1 class="govuk-heading-l">{{ locale.title }}</h1>

            <form id="edit-goal-form" method="POST">
                <input type="hidden" name="_csrf" value="{{ csrfToken }}">
                <input type="hidden" id="_areaOfNeed" value="{{ data.selectedAreaOfNeed.url }}">
                <input type="hidden" name="area-of-need" value="{{ data.selectedAreaOfNeed.name }}">
                <input type="hidden" id="page" value="goals">

                {{ govukInput({
                    label: {
                        text: locale.goalSelection.label,
                        classes: "govuk-label--m",
                        isPageHeading: false
                    },
                    hint: {
                        text: locale.goalSelection.hint
                    },
                    formGroup: {
                        classes: "goal-input-autocomplete-wrapper"
                    },
                    errorMessage: getFormattedError(errors, locale, 'goal-input-autocomplete'),
                    id: "goal-input-autocomplete",
                    name: "goal-input-autocomplete",
                    value: data.form['goal-input-autocomplete']
                }) }}

                {{ govukRadios({
                    name: "other-area-of-need-radio",
                    fieldset: {
                        legend: {
                            text: "Is this goal related to any other area of need?",
                            isPageHeading: false,
                            classes: "govuk-fieldset__legend--m"
                        }
                    },
                    errorMessage: getFormattedError(errors, locale, 'other-area-of-need-radio'),
                    items: [
                        {
                            value: "yes",
                            text: "Yes",
                            checked: data.form['other-area-of-need-radio'] == 'yes',
                            conditional: {
                            html: areasOfNeedHtml
                        }
                        },
                        {
                          value: "no",
                          text: "No",
                          checked: data.form['other-area-of-need-radio'] == 'no'
                        }
                    ]
                }) }}

                {{ govukRadios({
                    name: "start-working-goal-radio",
                    fieldset: {
                        legend: {
                            text: locale.startWorking.label,
                            isPageHeading: false,
                            classes: "govuk-fieldset__legend--m"
                        }
                    },
                    errorMessage: getFormattedError(errors, locale, 'start-working-goal-radio'),
                    items: [
                        {
                            value: "yes",
                            text: "Yes",
                            checked: data.form['start-working-goal-radio'] == 'yes',
                            conditional: {
                                html: customDateRadioHtml
                            }
                        },
                        {
                            value: "no",
                            text: "No, it is a future goal",
                            checked: data.form['start-working-goal-radio'] == 'no'
                        }
                    ]
                }) }}

                <div class="govuk-button-group">
                    {{ govukButton({
                        text: locale.saveButtonText,
                        name: "action",
                        value: "save"
                    }) }}
                </div>
            </form>
        </div>
    </div>
{% endblock %}